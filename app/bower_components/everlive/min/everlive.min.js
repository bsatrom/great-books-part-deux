/*!
The MIT License (MIT)

Copyright (c) 2013 Telerik AD

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.y distributed under the MIT license.
*/
/*!
 Everlive SDK
 Version 1.2.7
 */
(function(a,b){if(typeof define==="function"&&define.amd){define(["underscore","rsvp","reqwest","jstz"],function(f,e,c,d){return(a.Everlive=b(f,e,c,d))})}else{if(typeof exports==="object"){module.exports=b(require("underscore"),require("rsvp"))}else{a.Everlive=b(a._,a.RSVP,a.reqwest,a.jstz)}}}(this,function(C,k,m,h){var r=Array.prototype.slice;var F="//api.everlive.com/v1/";var i="Id";function a(I,G,H){if(!H){H="The "+G+" is required"}if(typeof I==="undefined"||I===null){throw new c(H)}}function y(G){this.url=F;this.apiKey=null;this.masterKey=null;this.token=null;this.tokenType=null;this.scheme="http";this._emulatorMode=G.emulatorMode;this.parseOnlyCompleteDateTimeObjects=false;if(typeof G==="string"){this.apiKey=G}else{C.extend(this,G)}}var u=[];function t(H){var G=this;this.setup=new y(H);C.each(u,function(I){I.func.call(G,H)});if(t.$===null){t.$=G}}t.$=null;t.idField=i;t.initializations=u;t.init=function(G){t.$=null;return new t(G)};t.buildUrl=function(G){var H="";if(typeof G.scheme==="string"){H+=G.scheme+":"}H+=G.url;if(G.apiKey){H+=G.apiKey+"/"}return H};t.prototype.data=function(G){return new f(this.setup,G)};t.prototype.buildUrl=function(){return t.buildUrl(this.setup)};var s=function(H,I){var G=null;if(I&&I.authHeaders===false){return G}if(H.token){G=(H.tokenType||"bearer")+" "+H.token}else{if(H.masterKey){G="masterkey "+H.masterKey}}if(G){return{Authorization:G}}else{return null}};t.prototype.buildAuthHeader=function(){return s(this.setup)};(function(){var M={query:1,where:100,filter:101,and:110,or:111,not:112,equal:120,not_equal:121,lt:122,lte:123,gt:124,gte:125,isin:126,notin:127,all:128,size:129,regex:130,contains:131,startsWith:132,endsWith:133,nearShpere:140,withinBox:141,withinPolygon:142,withinShpere:143,select:200,exclude:201,order:300,order_desc:301,skip:400,take:401,expand:402};function I(N,O){this.operator=N;this.operands=O||[]}I.prototype={addOperand:function(N){this.operands.push(N)}};function H(R,N,P,S,O,Q){this.filter=R;this.fields=N;this.sort=P;this.toskip=S;this.totake=O;this.expandExpression=Q;this.expr=new I(M.query)}H.prototype={where:function(N){if(N){return this._simple(M.filter,[N])}else{return new L(this)}},select:function(){return this._simple(M.select,arguments)},order:function(N){return this._simple(M.order,[N])},orderDesc:function(N){return this._simple(M.order_desc,[N])},skip:function(N){return this._simple(M.skip,[N])},take:function(N){return this._simple(M.take,[N])},expand:function(N){return this._simple(M.expand,[N])},build:function(){return new K(this).build()},_simple:function(P,N){var O=r.call(N);this.expr.addOperand(new I(P,O));return this}};function L(P,O,N){this.parent=P;this.single=N;this.expr=new I(O||M.where);this.parent.expr.addOperand(this.expr)}L.prototype={and:function(){return new L(this,M.and)},or:function(){return new L(this,M.or)},not:function(){return new L(this,M.not,true)},_simple:function(N){var O=r.call(arguments,1);this.expr.addOperand(new I(N,O));return this._done()},eq:function(O,N){return this._simple(M.equal,O,N)},ne:function(O,N){return this._simple(M.not_equal,O,N)},gt:function(O,N){return this._simple(M.gt,O,N)},gte:function(O,N){return this._simple(M.gte,O,N)},lt:function(O,N){return this._simple(M.lt,O,N)},lte:function(O,N){return this._simple(M.lte,O,N)},isin:function(O,N){return this._simple(M.isin,O,N)},notin:function(O,N){return this._simple(M.notin,O,N)},all:function(O,N){return this._simple(M.all,O,N)},size:function(O,N){return this._simple(M.size,O,N)},regex:function(P,O,N){return this._simple(M.regex,P,O,N)},startsWith:function(P,O,N){return this._simple(M.startsWith,P,O,N)},endsWith:function(P,O,N){return this._simple(M.endsWith,P,O,N)},nearSphere:function(P,N,Q,O){return this._simple(M.nearShpere,P,N,Q,O)},withinBox:function(O,P,N){return this._simple(M.withinBox,O,P,N)},withinPolygon:function(O,N){return this._simple(M.withinPolygon,O,N)},withinCenterSphere:function(Q,O,N,P){return this._simple(M.withinShpere,Q,O,N,P)},done:function(){if(this.parent instanceof L){return this.parent._done()}else{return this.parent}},_done:function(){if(this.single){return this.parent}else{return this}}};L.prototype.equal=L.prototype.eq;L.prototype.notEqual=L.prototype.ne;L.prototype.greaterThan=L.prototype.gt;L.prototype.greaterThanEqual=L.prototype.gte;L.prototype.lessThan=L.prototype.lt;L.prototype.lessThanEqual=L.prototype.lte;function K(N){this.query=N;this.expr=N.expr}var G={radians:"$maxDistance",km:"$maxDistanceInKilometers",miles:"$maxDistanceInMiles"};var J={radians:"radius",km:"radiusInKilometers",miles:"radiusInMiles"};K.prototype={build:function(){var N=this.query;if(N.filter||N.fields||N.sort||N.toskip||N.totake||N.expandExpression){return{$where:N.filter||null,$select:N.fields||null,$sort:N.sort||null,$skip:N.toskip||null,$take:N.totake||null,$expand:N.expandExpression||null}}return{$where:this._buildWhere(),$select:this._buildSelect(),$sort:this._buildSort(),$skip:this._getSkip(),$take:this._getTake(),$expand:this._getExpand()}},_getSkip:function(){var N=C.find(this.expr.operands,function(Q,O,P){return Q.operator===M.skip});return N?N.operands[0]:null},_getTake:function(){var N=C.find(this.expr.operands,function(Q,O,P){return Q.operator===M.take});return N?N.operands[0]:null},_getExpand:function(){var N=C.find(this.expr.operands,function(Q,O,P){return Q.operator===M.expand});return N?N.operands[0]:null},_buildSelect:function(){var O=C.find(this.expr.operands,function(R,P,Q){return R.operator===M.select});var N={};if(O){C.reduce(O.operands,function(P,Q){P[Q]=1;return P},N);return N}else{return null}},_buildSort:function(){var O=C.filter(this.expr.operands,function(R,P,Q){return R.operator===M.order||R.operator===M.order_desc});var N={};if(O.length>0){C.reduce(O,function(P,Q){P[Q.operands[0]]=Q.operator===M.order?1:-1;return P},N);return N}else{return null}},_buildWhere:function(){var N=C.find(this.expr.operands,function(R,P,Q){return R.operator===M.where});if(N){return this._build(new I(M.and,N.operands))}else{var O=C.find(this.expr.operands,function(R,P,Q){return R.operator===M.filter});if(O){return O.operands[0]}return null}},_build:function(N){if(this._isSimple(N)){return this._simple(N)}else{if(this._isRegex(N)){return this._regex(N)}else{if(this._isGeo(N)){return this._geo(N)}else{if(this._isAnd(N)){return this._and(N)}else{if(this._isOr(N)){return this._or(N)}else{if(this._isNot(N)){return this._not(N)}}}}}}},_isSimple:function(N){return N.operator>=M.equal&&N.operator<=M.size},_simple:function(R){var Q={},N={};var P=R.operands;var O=this._translateoperator(R.operator);if(O){Q[O]=P[1]}else{Q=P[1]}N[P[0]]=Q;return N},_isRegex:function(N){return N.operator>=M.regex&&N.operator<=M.endsWith},_regex:function(R){var N={};var Q=this._getRegex(R);var O=this._getRegexValue(Q);var P=R.operands;N[P[0]]=O;return N},_getRegex:function(P){var O=P.operands[1];var N=P.operands[2]?P.operands[2]:"";switch(P.operator){case M.regex:return O instanceof RegExp?O:new RegExp(O,N);case M.startsWith:return new RegExp("^"+O,N);case M.endsWith:return new RegExp(O+"$",N);default:throw new c("Unknown operator type.")}},_getRegexValue:function(O){var N="";if(O.global){N+="g"}if(O.multiline){N+="m"}if(O.ignoreCase){N+="i"}return{$regex:O.source,$options:N}},_isGeo:function(N){return N.operator>=M.nearShpere&&N.operator<=M.withinShpere},_geo:function(P){var N={};var O=P.operands;N[O[0]]=this._getGeoTerm(P);return N},_getGeoTerm:function(N){switch(N.operator){case M.nearShpere:return this._getNearSphereTerm(N);case M.withinBox:return this._getWithinBox(N);case M.withinPolygon:return this._getWithinPolygon(N);case M.withinShpere:return this._getWithinCenterSphere(N);default:throw new c("Unknown operator type.")}},_getNearSphereTerm:function(T){var P=T.operands;var N=this._getGeoPoint(P[1]);var S=P[2];var R=P[3];var O;var Q={"$nearSphere":N};if(typeof S!=="undefined"){O=G[R]||G.radians;Q[O]=S}return Q},_getWithinBox:function(Q){var O=Q.operands;var N=this._getGeoPoint(O[1]);var P=this._getGeoPoint(O[2]);return{"$within":{"$box":[N,P]}}},_getWithinPolygon:function(P){var N=P.operands;var O=this._getGeoPoints(N[1]);return{"$within":{"$polygon":O}}},_getWithinCenterSphere:function(T){var R=T.operands;var O=this._getGeoPoint(R[1]);var N=R[2];var S=R[3];var P=J[S]||J.radians;var Q={center:O};Q[P]=N;return{"$within":{"$centerSphere":Q}}},_getGeoPoint:function(N){if(C.isArray(N)){return new n(N[0],N[1])}return N},_getGeoPoints:function(O){var N=this;return C.map(O,function(P){return N._getGeoPoint(P)})},_isAnd:function(N){return N.operator===M.and},_and:function(S){var R,O,Q,N={};var P=S.operands;for(R=0,O=P.length;R<O;R++){Q=this._build(P[R]);N=this._andAppend(N,Q)}return N},_andAppend:function(R,O){var Q,N,P,T,U;var S=C.keys(O);for(Q=0,N=S.length;Q<N;Q++){P=S[Q];T=R[P];if(typeof T==="undefined"){R[P]=O[P]}else{U=O[P];if(typeof T==="object"&&typeof U==="object"){T=C.extend(T,U)}else{T=U}R[P]=T}}return R},_isOr:function(N){return N.operator===M.or},_or:function(S){var R,O,Q,N=[];var P=S.operands;for(R=0,O=P.length;R<O;R++){Q=this._build(P[R]);N.push(Q)}return{$or:N}},_isNot:function(N){return N.operator===M.not},_not:function(N){return{$not:this._build(N.operands[0])}},_translateoperator:function(N){switch(N){case M.equal:return null;case M.not_equal:return"$ne";case M.gt:return"$gt";case M.lt:return"$lt";case M.gte:return"$gte";case M.lte:return"$lte";case M.isin:return"$in";case M.notin:return"$nin";case M.all:return"$all";case M.size:return"$size"}throw new c("Unknown operator type.")}};t.Query=H;t.QueryBuilder=K}());var x=(function(){var R={filter:"X-Everlive-Filter",select:"X-Everlive-Fields",sort:"X-Everlive-Sort",skip:"X-Everlive-Skip",take:"X-Everlive-Take",expand:"X-Everlive-Expand"};var N=null;function H(T,U){a(T,"setup");a(U,"options");this.setup=T;this.method=null;this.endpoint=null;this.data=null;this.headers={};this.success=null;this.error=null;this.parse=H.parsers.simple;C.extend(this,U);this._init(U);N=this}H.prototype={send:function(){t.sendRequest(this)},buildAuthHeader:s,buildUrl:function P(T){return t.buildUrl(T)},buildQueryHeaders:function K(T){if(T){if(T instanceof t.Query){return H.prototype._buildQueryHeaders(T)}else{return H.prototype._buildFilterHeader(T)}}else{return{}}},_init:function(T){C.extend(this.headers,this.buildAuthHeader(this.setup,T),this.buildQueryHeaders(T.filter),T.headers)},_buildQueryHeaders:function(T){T=T.build();var U={};if(T.$where!==null){U[R.filter]=JSON.stringify(T.$where)}if(T.$select!==null){U[R.select]=JSON.stringify(T.$select)}if(T.$sort!==null){U[R.sort]=JSON.stringify(T.$sort)}if(T.$skip!==null){U[R.skip]=T.$skip}if(T.$take!==null){U[R.take]=T.$take}if(T.$expand!==null){U[R.expand]=JSON.stringify(T.$expand)}return U},_buildFilterHeader:function(T){var U={};U[R.filter]=JSON.stringify(T);return U}};t.Request=H;t.prototype.request=function(T){return new H(this.setup,T)};function S(X){if(N&&N.setup&&N.setup.parseOnlyCompleteDateTimeObjects){if(/^\d{4}-\d{2}-\d{2}$/.test(X)){return null}if(/^(\d{2}):(\d{2})(:(\d{2})(\.(\d+))?)?(Z|((\+|-)(\d{2}):(\d{2})))?$/.test(X)){return null}}var W;if(W=X.match(/^(\d{4})(-(\d{2})(-(\d{2})(T(\d{2}):(\d{2})(:(\d{2})(\.(\d+))?)?(Z|((\+|-)(\d{2}):(\d{2}))))?))$/)){var U=W[12];if(U){if(U.length>3){U=Math.round(Number(U.substr(0,3)+"."+U.substr(3)))}else{if(U.length<3){U+=U.length===2?"0":"00"}}}var V=new Date(Date.UTC(Number(W[1]),(Number(W[3])-1)||0,Number(W[5])||0,Number(W[7])||0,Number(W[8])||0,Number(W[10])||0,Number(U)||0));if(W[13]&&W[13]!=="Z"){var Y=Number(W[16])||0,T=Number(W[17])||0;Y*=3600000;T*=60000;var Z=Y+T;if(W[15]==="+"){Z=-Z}V=new Date(V.valueOf()+Z)}return V}else{return null}}function O(U,V){if(typeof V==="string"){var T=S(V);if(T){V=T}}return V}function L(X,U){var T,V,W;for(T in X){if(X.hasOwnProperty(T)){V=X[T];W=U(T,V);X[T]=W;if(V===W&&typeof V==="object"){L(V,U)}}}}function G(T){L(T,O)}t._traverseAndRevive=G;function I(T){if(typeof T==="string"&&T.length>0){T=JSON.parse(T,O)}else{if(typeof T==="object"){G(T)}}if(T){return{result:T.Result,count:T.Count}}else{return T}}function J(T){if(typeof T==="string"&&T.length>0){try{T=JSON.parse(T);return{message:T.message,code:T.errorCode}}catch(U){return T}}else{return T}}function Q(T){if(typeof T==="string"&&T.length>0){T=JSON.parse(T,O)}else{if(typeof T==="object"){G(T)}}if(T){return{result:T.Result}}else{return T}}function M(T){if(typeof T==="string"&&T.length>0){T=JSON.parse(T,O)}else{if(typeof T==="object"){G(T)}}if(T){return{result:T.Result,ModifiedAt:T.ModifiedAt}}else{return T}}H.parsers={simple:{result:I,error:J},single:{result:Q,error:J},update:{result:M,error:J}};t.disableRequestCache=function(T,W){if(W==="GET"){var U=(new Date()).getTime();var V=T.indexOf("?")>-1?"&":"?";T+=V+"_el="+U}return T};if(typeof t.sendRequest==="undefined"){t.sendRequest=function(U){var T=U.buildUrl(U.setup)+U.endpoint;T=t.disableRequestCache(T,U.method);var V=U.method==="GET"?U.data:JSON.stringify(U.data);m({url:T,method:U.method,data:V,headers:U.headers,type:"json",contentType:"application/json",crossOrigin:true,success:function(X,Y,W){U.success.call(U,U.parse.result(X))},error:function(W,Y,X){U.error.call(U,U.parse.error(W.responseText))}})}}return H}());t.getCallbacks=function(I,G){var H;if(typeof I!=="function"&&typeof G!=="function"){H=new k.Promise(function(K,J){I=function(L){K(L)};G=function(L){J(L)}})}return{promise:H,success:I,error:G}};function w(G,J,H){var I=t.getCallbacks(J,H);G(I.success,I.error);return I.promise}function B(G,H){return function(K,I){var J=K.result;if(C.isArray(G)||typeof G.length==="number"){C.each(G,function(M,L){C.extend(M,J[L])})}else{C.extend(G,J)}H(K,I)}}function l(G,H){return function(J){var I=J.ModifiedAt;G.ModifiedAt=I;H(J)}}function f(G,H){this.setup=G;this.collectionName=H;this.options=null}f.prototype={withHeaders:function(H){var G=this.options||{};G.headers=C.extend(G.headers||{},H);this.options=G;return this},expand:function(H){var G={"X-Everlive-Expand":JSON.stringify(H)};return this.withHeaders(G)},_createRequest:function(G){C.extend(G,this.options);this.options=null;return new x(this.setup,G)},get:function(I,J,H){var G=this;return w(function(M,K){var L=G._createRequest({method:"GET",endpoint:G.collectionName,filter:I,success:M,error:K});L.send()},J,H)},getById:function(J,I,H){var G=this;return w(function(M,K){var L=G._createRequest({method:"GET",endpoint:G.collectionName+"/"+J,parse:x.parsers.single,success:M,error:K});L.send()},I,H)},count:function(I,J,H){var G=this;return w(function(M,K){var L=G._createRequest({method:"GET",endpoint:G.collectionName+"/_count",filter:I,parse:x.parsers.single,success:M,error:K});L.send()},J,H)},create:function(I,J,H){var G=this;return w(function(M,K){var L=G._createRequest({method:"POST",endpoint:G.collectionName,data:I,parse:x.parsers.single,success:B(I,M),error:K});L.send()},J,H)},rawUpdate:function(I,J,K,H){var G=this;return w(function(P,M){var O=G.collectionName;var L=null;if(typeof J==="string"){O+="/"+J}else{if(typeof J==="object"){L=J}}var N=G._createRequest({method:"PUT",endpoint:O,data:I,filter:L,success:P,error:M});N.send()},K,H)},_update:function(I,K,M,J,L,H){var G=this;return w(function(S,N){var R=G.collectionName;var P=S;if(M){R+="/"+I[i];P=l(I,S)}var Q={};Q[J?"$replace":"$set"]=I;var O=G._createRequest({method:"PUT",endpoint:R,parse:x.parsers.update,data:Q,filter:K,success:P,error:N});O.send()},L,H)},updateSingle:function(H,I,G){return this._update(H,null,true,false,I,G)},update:function(H,I,J,G){return this._update(H,I,false,false,J,G)},_destroy:function(I,J,L,K,H){var G=this;return w(function(P,M){var O=G.collectionName;if(L){O+="/"+I[i]}var N=G._createRequest({method:"DELETE",endpoint:O,filter:J,success:P,error:M});N.send()},K,H)},destroySingle:function(H,I,G){return this._destroy(H,null,true,I,G)},destroy:function(H,I,G){return this._destroy(null,H,false,I,G)},setAcl:function(K,I,J,H){var G=this;return w(function(P,L){var O=G.collectionName;if(typeof I==="string"){O+="/"+I}else{if(typeof I==="object"){O+="/"+I[i]}}O+="/_acl";var Q,N;if(K===null){Q="DELETE"}else{Q="PUT";N=K}var M=G._createRequest({method:Q,endpoint:O,data:N,success:P,error:L});M.send()},J,H)},setOwner:function(G,J,K,I){var H=this;return w(function(O,L){var N=H.collectionName;if(typeof J==="string"){N+="/"+J}else{if(typeof J==="object"){N+="/"+J[i]}}N+="/_owner";var M=H._createRequest({method:"PUT",endpoint:N,data:{Owner:G},success:O,error:L});M.send()},K,I)},save:function(J,K,I){var H=this;var G=this.isNew(J);return w(function(O,L){function N(P){P.type=G?"create":"update";O(P)}function M(P){P.type=G?"create":"update";L(P)}if(G){return H.create(J,N,M)}else{return H.updateSingle(J,N,M)}},K,I)},isNew:function(G){return typeof G[i]==="undefined"}};t.Data=f;function n(G,H){this.longitude=G||0;this.latitude=H||0}t.GeoPoint=n;var g={unauthenticated:"unauthenticated",masterKey:"masterKey",invalidAuthentication:"invalidAuthentication",authenticated:"authenticated"};t.AuthStatus=g;function j(G,J,L,I){if(G.masterKey){return w(function(N,M){N({status:g.masterKey})},L,I)}if(!G.token){return w(function(N,M){N({status:g.unauthenticated})},L,I)}var H;if(L){H=function(M){if(M&&M.code===601){L({status:g.invalidAuthentication})}else{I(M)}}}var K=J(L,H);if(K){K=K.then(function(M){return{status:g.authenticated,user:M.result}},function(M){if(M&&M.code===601){return{status:g.invalidAuthentication}}else{throw M}})}return K}t.prototype.authInfo=function(H,G){return j(this.setup,C.bind(this.Users.getById,this.Users,"me"),H,G)};var d=function(G){G._loginSuccess=function(J){var I=J.result;var H=this.setup;H.token=I.access_token;H.tokenType=I.token_type};G._logoutSuccess=function(){var H=this.setup;H.token=null;H.tokenType=null};G.register=function(M,K,J,L,I){a(M,"username");a(K,"password");var H={Username:M,Password:K};C.extend(H,J);return this.create(H,L,I)};G.login=function(L,J,K,I){var H=this;return w(function(O,M){var N=new x(H.setup,{method:"POST",endpoint:"oauth/token",data:{username:L,password:J,grant_type:"password"},authHeaders:false,parse:x.parsers.single,success:function(){H._loginSuccess.apply(H,arguments);O.apply(null,arguments)},error:M});N.send()},K,I)};G.currentUser=function(J,I){var H=this;return w(function(L,K){j(H.setup,C.bind(H.getById,H,"me")).then(function(M){if(typeof M.user!=="undefined"){L({result:M.user})}else{L({result:null})}},function(M){K(M)})},J,I)};G.changePassword=function(N,J,M,K,L,I){var H=this;return w(function(R,O){var Q="Users/changepassword";if(K){Q+="?keepTokens=true"}var P=new x(H.setup,{method:"POST",endpoint:Q,data:{Username:N,Password:J,NewPassword:M},authHeaders:false,parse:x.parsers.single,success:R,error:O});P.send()},L,I)};G.logout=function(J,I){var H=this;return w(function(M,K){var L=new x(H.setup,{method:"GET",endpoint:"oauth/logout",success:function(){H._logoutSuccess.apply(H,arguments);M.apply(null,arguments)},error:K});L.send()},J,I)};G._loginWithProvider=function(J,L,K){var I={Identity:J};var H=this;return w(function(O,M){var N=new x(H.setup,{method:"POST",endpoint:"Users",data:I,authHeaders:false,parse:x.parsers.single,success:function(){H._loginSuccess.apply(H,arguments);O.apply(null,arguments)},error:M});N.send()},L,K)};G._linkWithProvider=function(I,K,L,J){var H=this;return w(function(O,M){var N=new x(H.setup,{method:"POST",endpoint:"Users/"+K+"/link",data:I,parse:x.parsers.single,success:O,error:M});N.send()},L,J)};G._unlinkFromProvider=function(L,K,M,J){var I={Provider:L};var H=this;return w(function(P,N){var O=new x(H.setup,{method:"POST",endpoint:"Users/"+K+"/unlink",data:I,parse:x.parsers.single,success:P,error:N});O.send()},M,J)};G.loginWithFacebook=function(J,K,I){var H={Provider:"Facebook",Token:J};return G._loginWithProvider(H,K,I)};G.linkWithFacebook=function(K,J,L,I){var H={Provider:"Facebook",Token:J};return G._linkWithProvider(H,K,L,I)};G.unlinkFromFacebook=function(I,J,H){return G._unlinkFromProvider("Facebook",I,J,H)};G.loginWithADFS=function(J,K,I){var H={Provider:"ADFS",Token:J};return G._loginWithProvider(H,K,I)};G.linkWithADFS=function(K,J,L,I){var H={Provider:"ADFS",Token:J};return G._linkWithProvider(H,K,L,I)};G.unlinkFromADFS=function(I,J,H){return G._unlinkFromProvider("ADFS",I,J,H)};G.loginWithLiveID=function(J,K,I){var H={Provider:"LiveID",Token:J};return G._loginWithProvider(H,K,I)};G.linkWithLiveID=function(K,J,L,I){var H={Provider:"LiveID",Token:J};return G._linkWithProvider(H,K,L,I)};G.unlinkFromLiveID=function(I,J,H){return G._unlinkFromProvider("LiveID",I,J,H)};G.loginWithGoogle=function(J,K,I){var H={Provider:"Google",Token:J};return G._loginWithProvider(H,K,I)};G.linkWithGoogle=function(K,J,L,I){var H={Provider:"Google",Token:J};return G._linkWithProvider(H,K,L,I)};G.unlinkFromGoogle=function(I,J,H){return G._unlinkFromProvider("Google",I,J,H)};G.loginWithTwitter=function(J,K,L,I){var H={Provider:"Twitter",Token:J,TokenSecret:K};return G._loginWithProvider(H,L,I)};G.linkWithTwitter=function(K,J,L,M,I){var H={Provider:"Twitter",Token:J,TokenSecret:L};return G._linkWithProvider(H,K,M,I)};G.unlinkFromTwitter=function(I,J,H){return G._unlinkFromProvider("Twitter",I,J,H)}};var p=function(G){G.getUploadUrl=function(){return t.buildUrl(this.setup)+this.collectionName};G.getDownloadUrl=function(H){return t.buildUrl(this.setup)+this.collectionName+"/"+H+"/Download"};G._getUpdateUrl=function(H){return this.collectionName+"/"+H+"/Content"};G.getUpdateUrl=function(H){return t.buildUrl(this.setup)+this._getUpdateUrl(H)};G.updateContent=function(H,K,L,J){var I=this;return w(function(P,M){var O=I._getUpdateUrl(H);var N=I._createRequest({method:"PUT",endpoint:O,data:K,success:P,error:M});N.send()},L,J)};G.getDownloadUrlById=function(H,K,J){var I=this;return w(function(N,L){var M=I._createRequest({method:"GET",endpoint:I.collectionName+"/"+H,parse:x.parsers.single,success:function(O){N(O.result.Uri)},error:L});M.send()},K,J)}};var E={WindowsPhone:1,Windows:2,Android:3,iOS:4,OSX:5,Blackberry:6,Nokia:7,Unknown:100};t.PushCallbacks={};var o=function(G){this._el=G;this.notifications=G.data("Push/Notifications");this.devices=G.data("Push/Devices")};o.prototype={currentDevice:function(G){if(arguments.length===0){G=this._el.setup._emulatorMode}if(!window.cordova){throw new c("Error: currentDevice() can only be called from within a hybrid mobile app, after 'deviceready' event has been fired.")}if(!this._currentDevice){this._currentDevice=new b(this)}this._currentDevice.emulatorMode=G;return this._currentDevice},register:function(J,L,H){var I=this.currentDevice();if(J&&J.android){J.android.senderID=J.android.projectNumber||J.android.senderID}var G=function(M,N){return function(){var O=new e(M);N(O)}};var K=function(N,O){var M=D.fromEverliveError(N);O(M)};return w(function(N,M){I.enableNotifications(J,function(P){var Q=P.token;var O=J?J.customParameters:undefined;I.getRegistration().then(function(){I.updateRegistration(O,G(Q,N),function(R){K(R,M)})},function(R){if(R.code===801){I.register(O,G(Q,N),M)}else{K(R,M)}})},function(P){var O=D.fromPluginError(P);M(O)})},L,H)},unregister:function(I,H){var G=this.currentDevice();return G.disableNotifications.apply(G,arguments)},updateRegistration:function(G,J,I){var H=this.currentDevice();return H.updateRegistration.apply(H,arguments)},getRegistration:function(I,H){var G=this.currentDevice();return G.getRegistration.apply(G,arguments)},send:function(H,I,G){return this.notifications.create.apply(this.notifications,arguments)}};var q={iOS:{badge:true,sound:true,alert:true},android:{senderID:null},notificationCallbackAndroid:null,notificationCallbackIOS:null};var b=function(G){this._pushHandler=G;this._initSuccessCallback=null;this._initErrorCallback=null;this._globalFunctionSuffix=null;this.pushSettings=null;this.pushToken=null;this.isInitialized=false;this.isInitializing=false;this.emulatorMode=false};b.prototype={enableNotifications:function(G,I,H){this.pushSettings=G;return w(C.bind(this._initialize,this),I,H)},disableNotifications:function(I,H){var G=this;return this.unregister().then(function(){return w(function(N,L){if(G.emulatorMode){N()}else{var J=window.plugins.pushNotification;var M;var K=G._getPlatformType(device.platform);if(K===E.WindowsPhone){M={channelName:G.pushSettings.wp8.channelName}}J.unregister(function(){G.isInitialized=false;N()},L,M)}},I,H)},H)},getRegistration:function(I,G){var H=this._getDeviceId();return this._pushHandler.devices.getById("HardwareId/"+H,I,G)},register:function(H,K,I){var G=this;var J={};if(H!==undefined){J.Parameters=H}return this._populateRegistrationObject(J).then(function(){return G._pushHandler.devices.create(J,K,I)},I)},unregister:function(I,G){var H=device.uuid;return this._pushHandler.devices.destroySingle({Id:"HardwareId/"+H},I,G)},updateRegistration:function(H,K,I){var G=this;var J={};if(H){J.Parameters=H}return this._populateRegistrationObject(J).then(function(){J.Id="HardwareId/"+J.HardwareId;return G._pushHandler.devices.updateSingle(J,K,I)},I)},_initialize:function(R,P){var T=this;if(this.isInitializing){P(new c("Push notifications are currently initializing."));return}if(!this.emulatorMode&&(!window.navigator||!window.navigator.globalization)){P(new c("The globalization plugin is not initialized."));return}if(!this.emulatorMode&&(!window.plugins||!window.plugins.pushNotification)){P(new c("The push notifications plugin is not initialized."));return}this._initSuccessCallback=R;this._initErrorCallback=P;if(this.isInitialized){this._deviceRegistrationSuccess(this.pushToken);return}if(this.emulatorMode){setTimeout(function(){T._deviceRegistrationSuccess("fake_push_token")},1000);return}this.isInitializing=true;var S=this._globalFunctionSuffix;if(!S){S=Date.now().toString();this._globalFunctionSuffix=S}var H=window.plugins.pushNotification;var K=this._getPlatformType(device.platform);if(K===E.iOS){var M="apnCallback_"+S;t.PushCallbacks[M]=C.bind(this._onNotificationAPN,this);var O=this.pushSettings.iOS;this._validateIOSSettings(O);O.ecb="Everlive.PushCallbacks."+M;H.register(C.bind(this._successfulRegistrationAPN,this),C.bind(this._failedRegistrationAPN,this),O)}else{if(K===E.Android){var G="gcmCallback_"+S;t.PushCallbacks[G]=C.bind(this._onNotificationGCM,this);var J=this.pushSettings.android;this._validateAndroidSettings(J);J.ecb="Everlive.PushCallbacks."+G;H.register(C.bind(this._successSentRegistrationGCM,this),C.bind(this._errorSentRegistrationGCM,this),J)}else{if(K===E.WindowsPhone){var L="wp8Callback_"+S;var Q="wp8RegistrationSuccessCallback_"+S;var I="wp8RegistrationErrorCallback_"+S;t.PushCallbacks[L]=C.bind(this._onNotificationWP8,this);t.PushCallbacks[Q]=C.bind(this._deviceRegistrationSuccessWP,this);t.PushCallbacks[I]=C.bind(this._deviceRegistrationFailed,this);var N=this.pushSettings.wp8;this._validateWP8Settings(N);N.ecb="Everlive.PushCallbacks."+L;N.uccb="Everlive.PushCallbacks."+Q;N.errcb="Everlive.PushCallbacks."+I;H.register(C.bind(this._successSentRegistrationWP8,this),C.bind(this._errorSentRegistrationWP8,this),N)}else{throw new c("The current platform is not supported: "+device.platform)}}}},_deviceRegistrationSuccessWP:function(G){this._deviceRegistrationSuccess(G.uri)},_validateAndroidSettings:function(G){if(!G.senderID){throw new c("Sender ID (project number) is not set in the android settings.")}},_validateWP8Settings:function(G){if(!G.channelName){throw new c("channelName is not set in the WP8 settings.")}},_validateIOSSettings:function(G){},_populateRegistrationObject:function(I,J,H){var G=this;return w(function(L,K){if(!G.pushToken){throw new c("Push token is not available.")}G._getLocaleName(function(M){var S=G._getDeviceId();var Q=device.name;var O=G._getPlatformType(device.platform);var P=h.determine().name();var N=G.pushToken;var T=M.value;var R=device.version;I.HardwareId=S;I.HardwareModel=Q;I.PlatformType=O;I.PlatformVersion=R;I.TimeZone=P;I.PushToken=N;I.Locale=T;L()},K)},J,H)},_getLocaleName:function(H,G){if(this.emulatorMode){H({value:"en_US"})}else{navigator.globalization.getLocaleName(function(I){H(I)},G);navigator.globalization.getLocaleName(function(I){},G)}},_getDeviceId:function(){return device.uuid},_getPlatformType:function(H){var G=H.toLowerCase();switch(G){case"ios":case"iphone":case"ipad":return E.iOS;case"android":return E.Android;case"wince":return E.WindowsPhone;case"win32nt":return E.WindowsPhone;default:return E.Unknown}},_deviceRegistrationFailed:function(G){this.pushToken=null;this.isInitializing=false;this.isInitialized=false;if(this._initErrorCallback){this._initErrorCallback({error:G})}},_deviceRegistrationSuccess:function(G){this.pushToken=G;this.isInitializing=false;this.isInitialized=true;if(this._initSuccessCallback){this._initSuccessCallback({token:G})}},_successfulRegistrationAPN:function(G){this._deviceRegistrationSuccess(G)},_failedRegistrationAPN:function(G){this._deviceRegistrationFailed(G)},_successSentRegistrationGCM:function(G){},_successSentRegistrationWP8:function(G){},_errorSentRegistrationWP8:function(G){this._deviceRegistrationFailed(G)},_errorSentRegistrationGCM:function(G){this._deviceRegistrationFailed(G)},_onNotificationAPN:function(G){this._raiseNotificationEventIOS(G)},_onNotificationWP8:function(G){this._raiseNotificationEventWP8(G)},_onNotificationGCM:function z(G){switch(G.event){case"registered":if(G.regid.length>0){this._deviceRegistrationSuccess(G.regid)}break;case"message":this._raiseNotificationEventAndroid(G);break;case"error":if(!this.pushToken){this._deviceRegistrationFailed(G)}else{this._raiseNotificationEventAndroid(G)}break;default:this._raiseNotificationEventAndroid(G);break}},_raiseNotificationEventAndroid:function(G){if(this.pushSettings.notificationCallbackAndroid){this.pushSettings.notificationCallbackAndroid(G)}},_raiseNotificationEventIOS:function(G){if(this.pushSettings.notificationCallbackIOS){this.pushSettings.notificationCallbackIOS(G)}},_raiseNotificationEventWP8:function(G){if(this.pushSettings.notificationCallbackWP8){this.pushSettings.notificationCallbackWP8(G)}}};function c(){var G=Error.apply(this,arguments);G.name=this.name="EverliveError";this.message=G.message;Object.defineProperty(this,"stack",{get:function(){return G.stack}});return this}c.prototype=Object.create(Error.prototype);c.prototype.toJSON=function(){return{name:this.name,message:this.message,stack:this.stack}};var D=function(I,H,G){c.call(this,H);this.errorType=I;this.message=H;if(G!==undefined){this.additionalInformation=G}};D.prototype=Object.create(c.prototype);D.fromEverliveError=function(H){var G=new D(v.EverliveError,H.message,H);return G};D.fromPluginError=function(H){var I="A plugin error occurred";if(H){if(typeof H.error==="string"){I=H.error}else{if(typeof H.message==="string"){I=H.message}}}var G=new D(v.PluginError,I,H);return G};var v={EverliveError:1,PluginError:2};var e=function(G){this.token=G};var A=function(){this.Users=this.data("Users");d(this.Users);this.Files=this.data("Files");p(this.Files);this.push=new o(this)};u.push({name:"default",func:A});return t}));
